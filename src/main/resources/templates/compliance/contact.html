<div id="form2" style="display: flex; margin-bottom: 20px;"
     th:fragment="form2(data,complianceButton)">
    <form id="myContact">

        <button id="prev1" style="color: #007bff; border: none; background: none; padding: 5px; cursor: pointer; transition: 0.3s;">
            <i class="bi bi-arrow-left-circle-fill fs-6"></i>
        </button>

        <div style="background-color: #FFFFFF; border: 1px solid #F0F0F0;border-radius: 4px; padding: 28px;max-height: fit-content;min-width: 350px;">
            <h1 style="color: #062C5A;font-size: 1rem;">Contact</h1>
            <div class="mb-3">
                <label class="form-label" style="font-size: 0.75rem;color: #405979;" for="generalEmail">
                    General Email<span style="color: #EF5350;">*</span>
                </label>
                <input
                        style="width:100%; background-color: #FAFAFA; font-size: 0.75rem;"
                        type="email" name="generalEmail" class="form-control"
                        id="generalEmail" th:value="${data!=null?data['generalEmail']:''}" required
                        oninput="validateEmail(this)">
                <div class="error-message" style="display: none; color: red;">Please enter a valid email address.</div>
            </div>

            <div class="mb-3">
                <label class="form-label" style="font-size: 0.75rem;color: #405979;" for="supportingEmail">
                    Support Email<span style="color: #EF5350;">*</span>
                </label>
                <input
                        style="width:100%; background-color: #FAFAFA;font-size: 0.75rem;"
                        type="email" name="supportingEmail" class="form-control"
                        id="supportingEmail" th:value="${data!=null?data['supportingEmail']:''}" required
                        oninput="validateEmail(this)">
                <div class="error-message" style="display: none; color: red;">Please enter a valid email address.</div>
            </div>
            <div class="form-check">
                <input name="useGeneralEmail" class="form-check-input" type="checkbox" id="useGeneralEmail" style="margin-top: 0.4rem;">
                <label style="color: #6F768D;font-size: 0.75rem;" class="form-check-label" for="useGeneralEmail">
                    Use general email
                </label>
            </div>
            <div class="mb-3">
                <label class="form-label" style="font-size: 0.75rem;color: #405979;" for="disputeEmail">Dispute Email<span style="color: #EF5350;">*</span></label>
                <input style="width:100%; background-color: #FAFAFA;font-size: 0.75rem;" type="email" th:value="${data!=null?data['disputeEmail']:''}" name="disputeEmail" class="form-control" id="disputeEmail" required oninput="validateEmail(this)">
                <div class="error-message">Please enter a valid email address.</div>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="useGeneralEmail" name="useGeneralEmail" style="margin-top: 0.4rem;">
                <label style="color: #6F768D;font-size: 0.75rem;" class="form-check-label" for="useGeneralEmail">
                    Use general email
                </label>
            </div>
            <div class="mb-3">
                <label class="form-label" style="font-size: 0.75rem;color: #405979;" for="phoneNumber">Phone Number<span style="color: #EF5350;">*</span></label>
                <input _="on input set #contact-phone-number.textContent to me.value" style="width:100%; background-color: #FAFAFA;font-size: 0.75rem;" type="tel" name="phoneNumber" class="form-control" th:value="${data!=null?data['phoneNumber']:''}" id="phoneNumber" required>                   </div>
            <div class="mb-3">
                <label class="form-label" style="font-size: 0.75rem;color: #405979;" for="website">Website</label>
                <input _="on input set #contact-phone-number.textContent to me.value" style="width:100%; background-color: #FAFAFA;font-size: 0.75rem;" type="text" name="website" th:value="${data!=null?data['website']:''}" class="form-control" id="website" >              </div>
            <h1 class="mt-5" style="color: #062C5A;font-size: 1rem;">Business Address</h1>
            <div class="mb-3">
                <label style="font-size: 0.75rem;color: #405979;" for="country2" class="form-label">Country<span style="color: #EF5350;">*</span></label>
                <select _="on change set #contact-business-country.textContent to me.options[me.selectedIndex].text" required name="businesscountry" id="country2" class="form-select" style="font-size: 0.75rem;background-color: #FAFAFA;" th:data-selected="${data != null ? data['businesscountry'] : ''}" >
                    <option value="Select">Select</option>

                </select>
            </div>
            <div class="mb-3">
                <label style="font-size: 0.75rem;color: #405979;" for="cities1" class="form-label">State<span style="color: #EF5350;">*</span></label>
                <select _="on change set #contact-business-state.textContent to me.options[me.selectedIndex].text" required name="state" id="cities1" class="form-select" style="font-size: 0.75rem;background-color: #FAFAFA;" th:data-selected="${data != null ? data['state'] : ''}">
                    <option value="Select">Select</option>

                </select>
            </div>
            <div class="mb-3">
                <label class="form-label" style="font-size: 0.75rem;color: #405979;" for="city">City<span style="color: #EF5350;">*</span></label>
                <input _="on input set #contact-business-city.textContent to me.value" style="width:100%; background-color: #FAFAFA;font-size: 0.75rem;" type="text" name="city" class="form-control" th:value="${data!=null?data['city']:''}" id="city" required >       </div>
            <div class="mb-3">
                <label class="form-label" style="font-size: 0.75rem;color: #405979;" for="street">Street Address <span style="color: #EF5350;">*</span></label>
                <input _="on input set #contact-business-state-address.textContent to me.value" style="width:100%; background-color: #FAFAFA;font-size: 0.75rem;" type="text" name="street" class="form-control" th:value="${data!=null?data['street']:''}" id="street" required >         </div>
            <div class="mb-3">
                <label class="form-label" style="font-size: 0.75rem;color: #405979;" for="building">Building Name</label>
                <input _="on input set #contact-business-building-name.textContent to me.value" style="width:100%; background-color: #FAFAFA;font-size: 0.75rem;" type="text" name="building" class="form-control" placeholder="E.g: Unit required/Floor Number" th:value="${data!=null?data['building']:''}" id="building" >
            </div>
        </div>
        <button id="next2"
                th:class="@{'mt-2 saveButton '+${complianceButton}}"
                hx-post="/merchant/newMerchant/2"
                hx-trigger="click"
                hx-include="#myContact"
        >Save</button>
    </form>

    <script>
        function populateCountrySelect(selectElement, selectedCountry, callback) {
            fetch("https://restcountries.com/v3.1/all")
                .then(response => response.json())
                .then(countries => {
                    countries.sort((a, b) => (a.name?.common || "").localeCompare(b.name?.common || ""));
                    selectElement.innerHTML = '';

                    if (!selectedCountry) {
                        const defaultOption = document.createElement("option");
                        defaultOption.value = "";
                        defaultOption.textContent = "Select a country";
                        selectElement.appendChild(defaultOption);
                    }

                    countries.forEach(country => {
                        const option = document.createElement("option");
                        const countryCode = country.cca2;

                        option.value = countryCode;
                        option.textContent = country.name?.common || 'Unknown Country';

                        if (countryCode === selectedCountry) {
                            option.selected = true;
                        }

                        selectElement.appendChild(option);
                    });

                    if (callback) callback(); // Ensure populateCities runs AFTER population
                })
                .catch(error => console.error("Error fetching countries:", error));
        }


        const countrySelect2 = document.getElementById("country2");

        // Populate each select box with data
        populateCountrySelect(countrySelect2, countrySelect2.getAttribute("data-selected"), populateCities); // Ensuring it runs after population


        function populateCities() {
            const countrySelect = document.getElementById("country2");
            const citySelect = document.getElementById("cities1");
            const selectedState = citySelect.getAttribute("data-selected");
            citySelect.innerHTML = '<option value="">-- Select City --</option>'; // Clear existing options

            if (countrySelect.value === "NG") { // NG is the country code for Nigeria
                const nigerianCities = ["Lagos", "Abuja", "Kano", "Port Harcourt", "Ibadan", "Benin City"];
                nigerianCities.forEach(city => {
                    let option = document.createElement("option");
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                    if (city === selectedState) {
                        option.selected = true;
                    }

                    citySelect.appendChild(option);
                });

            }

        }


        document.getElementById('country2').addEventListener('change', populateCities)
        const form = document.getElementById("myContact");
        const submitButton = document.getElementById("next2");

        function toggleSubmitButton() {
            const requiredFields = form.querySelectorAll("[required]");
            let allFilled = true;

            requiredFields.forEach(field => {
                if (!field.value.trim() || (field.tagName === "SELECT" && field.value === "Select")) {
                    allFilled = false;
                }
            });

            submitButton.disabled = !allFilled;
        }

        form.addEventListener("input", toggleSubmitButton);
        form.addEventListener("change", toggleSubmitButton);

        // Initial check on page load
        toggleSubmitButton();

        document.getElementById('next2').addEventListener('click',increaseProgress)
        function increaseProgress() {
            const numberElement = document.getElementById("increase");
            const bar = document.getElementById("progress-bar");

            let currentNumber = parseInt(numberElement.textContent, 10);
            let newNumber = currentNumber + 20; // Store the updated number

            numberElement.textContent = newNumber;
            bar.style.width = `${newNumber}%`; // Use the updated number
            $(".cb2").prop("checked", true);
            scrollToTop()
        }

        function validateEmail(input) {
            const errorMessage = input.nextElementSibling; // Select the specific error message
            if (input.value.match(/^[^@]+@[^@]+\.[^@]+$/)) {
                input.classList.remove('invalid');
                errorMessage.style.display = 'none';
            } else {
                input.classList.add('invalid');
                errorMessage.style.display = 'block';
            }
        }
        function scrollToTop() {
            const content = document.querySelector(".content");
            if (content && content.scrollHeight > content.clientHeight) {
                content.offsetHeight; // Force reflow
                if ('scrollBehavior' in document.documentElement.style) {
                    content.scrollTo({top: 0, behavior: "smooth"});
                } else {
                    content.scrollTo(0, 0); // Fallback for older browsers
                }
            } else {
                document.body.offsetHeight; // Force reflow
                if ('scrollBehavior' in document.documentElement.style) {
                    window.scrollTo({top: 0, behavior: "smooth"});
                } else {
                    window.scrollTo(0, 0); // Fallback for older browsers
                }
            }
        }
    </script>
</div>
